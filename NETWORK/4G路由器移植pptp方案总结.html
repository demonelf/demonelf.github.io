<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>4G路由器移植pptp方案总结 | 芯机智</title>
  
  

  
  <link rel="alternate" href="/atom.xml" title="芯机智">
  

  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.10.1/css/all.min.css">
  

  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.8/css/style.css">
  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
</head>

<body>
  
  
  <div class="cover-wrapper">
    <cover class='cover post half'>
      
        
  <h1 class='title'>Material X</h1>


  <div class="m_search">
    <form name="searchform" class="form u-search-form">
      <input type="text" class="input u-search-input" placeholder="" />
      <i class="icon fas fa-search fa-fw"></i>
    </form>
  </div>

<div class='menu navgation'>
  <ul class='h-list'>
    
      
        <li>
          <a class="nav home" href="/"
            
            
            id="home">
            <i class='fas fa-rss fa-fw'></i>&nbsp;博文
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/projects/"
            
            
            id="projects">
            <i class='fas fa-code-branch fa-fw'></i>&nbsp;项目
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/friends/"
            
              rel="nofollow"
            
            
            id="friends">
            <i class='fas fa-link fa-fw'></i>&nbsp;友链
          </a>
        </li>
      
        <li>
          <a class="nav home" href="/about/"
            
              rel="nofollow"
            
            
            id="about">
            <i class='fas fa-info-circle fa-fw'></i>&nbsp;关于
          </a>
        </li>
      
    
  </ul>
</div>

      
    </cover>
    <header class="l_header pure">
  <div id="loading-bar-wrapper">
    <div id="loading-bar" class="pure"></div>
  </div>

	<div class='wrapper'>
		<div class="nav-main container container--flex">
      <a class="logo flat-box" href='/' >
        
          芯机智
        
      </a>
			<div class='menu navgation'>
				<ul class='h-list'>
          
  					
  						<li>
								<a class="nav flat-box" href="/"
                  
                  
                  id="home">
									<i class='fas fa-grin fa-fw'></i>&nbsp;示例
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/blog/categories/"
                  
                    rel="nofollow"
                  
                  
                  id="blogcategories">
									<i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/blog/tags/"
                  
                    rel="nofollow"
                  
                  
                  id="blogtags">
									<i class='fas fa-hashtag fa-fw'></i>&nbsp;标签
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/blog/archives/"
                  
                    rel="nofollow"
                  
                  
                  id="blogarchives">
									<i class='fas fa-archive fa-fw'></i>&nbsp;归档
								</a>
							</li>
      			
      		
				</ul>
			</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="搜索" />
						<i class="icon fas fa-search fa-fw"></i>
					</form>
				</div>
			
			<ul class='switcher h-list'>
				
					<li class='s-search'><a class="fas fa-search fa-fw" href='javascript:void(0)'></a></li>
				
				<li class='s-menu'><a class="fas fa-bars fa-fw" href='javascript:void(0)'></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo flat-box"></a>
			<ul class='switcher h-list'>
				<li class='s-comment'><a class="flat-btn fas fa-comments fa-fw" href='javascript:void(0)'></a></li>
        
          <li class='s-toc'><a class="flat-btn fas fa-list fa-fw" href='javascript:void(0)'></a></li>
        
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
    <header>
		<nav class="menu navgation">
      <ul>
        
          
            <li>
							<a class="nav flat-box" href="/"
                
                
                id="home">
								<i class='fas fa-clock fa-fw'></i>&nbsp;近期文章
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/blog/archives/"
                
                  rel="nofollow"
                
                
                id="blogarchives">
								<i class='fas fa-archive fa-fw'></i>&nbsp;文章归档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/projects/"
                
                
                id="projects">
								<i class='fas fa-code-branch fa-fw'></i>&nbsp;开源项目
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/friends/"
                
                  rel="nofollow"
                
                
                id="friends">
								<i class='fas fa-link fa-fw'></i>&nbsp;我的友链
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="https://xaoxuu.com/wiki/material-x/"
                
                  rel="nofollow"
                
                
                id="https:xaoxuu.comwikimaterial-x">
								<i class='fas fa-book fa-fw'></i>&nbsp;主题文档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/about/"
                
                  rel="nofollow"
                
                
                id="about">
								<i class='fas fa-info-circle fa-fw'></i>&nbsp;关于小站
							</a>
            </li>
          
       
      </ul>
		</nav>
    </header>
	</aside>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      <div class='l_main'>
  

  
    <article id="post" class="post white-box article-type-post" itemscope itemprop="blogPost">
      


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/NETWORK/4G路由器移植pptp方案总结.html">
        4G路由器移植pptp方案总结
      </a>
    </h1>
  


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    <a href="http://demonelf.github.io" rel="nofollow">
      
        <i class="fas fa-user" aria-hidden="true"></i>
      
      <p>madhex</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-calendar-alt" aria-hidden="true"></i>
    <p>2017-08-17</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/categories/NETWORK/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>NETWORK</p>
    </a>
  </div>


          
        
          
            
  
    <div class="new-meta-item browse busuanzi">
      <a class='notlink'>
        <i class="fas fa-eye" aria-hidden="true"></i>
        <p>
          <span id="busuanzi_value_page_pv">
            <i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i>
          </span>
        </p>
      </a>
    </div>
  


          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


      <section class="article typo">
        <div class="article-entry" itemprop="articleBody">
          <h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2><h3 id="pppoe总框架原理"><a href="#pppoe总框架原理" class="headerlink" title="pppoe总框架原理"></a>pppoe总框架原理</h3><p><img src="PPP框架原理.jpg" alt=""></p>
<h3 id="pptp总框架原理"><a href="#pptp总框架原理" class="headerlink" title="pptp总框架原理"></a>pptp总框架原理</h3><p><img src="pptp原理框架.JPG" alt=""></p>
<h2 id="ppp可行性分析"><a href="#ppp可行性分析" class="headerlink" title="ppp可行性分析"></a>ppp可行性分析</h2><h3 id="本文介绍"><a href="#本文介绍" class="headerlink" title="本文介绍"></a>本文介绍</h3><p>​    现需要在我们自己公司的4G路由器上移植pptp功能. 4G路由器硬件为mips.本来只需把开源的pptp和pppd编译对应的mips版本即可.但是由于4G路由本身有一套ppp库代码.为了实现软件的优化和可控性,我们想把开源的pptp和我们系统已有的ppp库实现融合. 由于ppp库没有使用手册,并且想要修改pptp实现各种我们需要的定制功能,例:按需拨号,自动重连等功能.我们先需要分析ppp vpn框架原理和ppp代码实现.来完成我们的pptp项目软件设计.</p>
<h3 id="难点"><a href="#难点" class="headerlink" title="难点"></a>难点</h3><p>​    一 需要捋顺整个ppp相关框架也就是以上框架图,同时还要掌握框架中用到的内核关键结构体和index,应用用到的fd等.</p>
<p>​    二 需要掌握pppd的协议状态机.</p>
<h3 id="tty简介"><a href="#tty简介" class="headerlink" title="tty简介"></a>tty简介</h3><p>首先需熟悉tty驱动框架,然后再分析ppp是如何结合tty框架实现的.</p>
<p>整个 uart 框架大概的样子如上图所示，简单来分的话可以说成两层，一层是下层我们的串口驱动层，它直接与硬件相接触，我们需要填充一个 struct uart_ops 的结构体，另一层是上层 tty 层，包括 tty 核心以及线路规程，它们各自都有一个 Ops 结构，用户空通过间是 tty 注册的字符设备节点来访问，这么说来如上图所示涉及到了4个 ops 结构了，层层跳转。。</p>
<p><img src="tty驱动框架.gif" alt=""></p>
<h3 id="ppp内核态tty框架实现代码"><a href="#ppp内核态tty框架实现代码" class="headerlink" title="ppp内核态tty框架实现代码"></a>ppp内核态tty框架实现代码</h3><p>ppp利用了tty中的规程层,实现了通过tty截获与发送数据.</p>
<p>在PPP驱动程序中, </p>
<p>每一tty终端设备对应于一条PPP传输通道(channel), </p>
<p>每一ppp网络设备对应于一个PPP接口单元(unit)</p>
<h4 id="ppp内核态重要结构体"><a href="#ppp内核态重要结构体" class="headerlink" title="ppp内核态重要结构体"></a>ppp内核态重要结构体</h4><pre><code class="c">struct channel{
    struct ppp /*包含struct ppp_file而ppp_file中包含index*/
    struct ppp_channel/*也包含struct channel*/
} /*generic定义*/

struct ppp {
    struct ppp_file    file;
}/*generic定义*/

struct ppp_file {
    int index;
}/*generic定义*/

struct asyncppp{
    struct ppp_channel/*包含struct channel找到index*/
}/*ppp_async定义 ppp_asynctty_open中初始化*/

ppp_asynctty_open初始化了
{
    struct asyncppp
    struct ppp_channel
    struct channel
    struct ppp_file
}
/*此函数很关键,要掌握如何调用此函数,也就更熟悉pppd初始化原理了*/
/*ppp_asynctty_open初始化了以上大部分结构体*/
/*调用此ppp_asynctty_open函数的位置比较隐蔽*/
/*是在pppd通过ioctl绑定规程时内核函数tty_set_ldisc中调用了此函数*/
/*以上结构体都初始化好后,pppd就可以通过/dev/ppp绑定channel_id了*/
</code></pre>
<h4 id="pppd摘要代码框架"><a href="#pppd摘要代码框架" class="headerlink" title="pppd摘要代码框架"></a>pppd摘要代码框架</h4><pre><code class="c">int main(argc, argv){
      /*配置参数*/
      ...
    magic_init();
    /* Initialize each protocol.*/
    for (i = 0; (protp = protocols[i]) != NULL; ++i)
        (*protp-&gt;init)(0);
    /*创建虚拟接口*/
    ppp_available();
    for (i = 0; (protp = protocols[i]) != NULL; ++i)
        if (protp-&gt;check_options != NULL)
            (*protp-&gt;check_options)();
    if (the_channel-&gt;check_options)
        (*the_channel-&gt;check_options)();
      /*进入状态机*/
    for (;;) {
          lcp_open(0);        /* Start protocol */
          start_link(0);
          while (phase != PHASE_DEAD) {
        }
        lcp_close(0, &quot;&quot;);
    }
}
</code></pre>
<h4 id="ppp框架中的-tty用户层"><a href="#ppp框架中的-tty用户层" class="headerlink" title="ppp框架中的(tty用户层)"></a>ppp框架中的(tty用户层)</h4><pre><code class="c">//在tty_register_device中注册
</code></pre>
<h4 id="ppp框架中的-tty核心层"><a href="#ppp框架中的-tty核心层" class="headerlink" title="ppp框架中的(tty核心层)"></a>ppp框架中的(tty核心层)</h4><pre><code class="c">//在注册驱动层中注册的核心层  
1、为线路规程和termios分配空间，并使 tty_driver 相应的成员指向它们。
2、注册字符设备，名字是 uart_driver-&gt;name 我们这里是“ttySAC”,文件操作函数集是 tty_fops。
3、将该 uart_driver-&gt;tty_drivers 添加到全局链表 tty_drivers 。
4、向 proc 文件系统添加 driver ，这个暂时不了解。
int tty_register_driver(struct tty_driver *driver)  
{  
    tty_register_device(driver, i, NULL);  
    return 0;  
}
</code></pre>
<h4 id="ppp框架中的-tty规程层"><a href="#ppp框架中的-tty规程层" class="headerlink" title="ppp框架中的(tty规程层)"></a>ppp框架中的(tty规程层)</h4><pre><code class="c">ppp_async.c
static struct tty_ldisc_ops ppp_ldisc = {
    .owner  = THIS_MODULE,
    .magic    = TTY_LDISC_MAGIC,
    .name    = &quot;ppp&quot;,
    .open    = ppp_asynctty_open,
    .close    = ppp_asynctty_close,
    .hangup    = ppp_asynctty_hangup,
    .read    = ppp_asynctty_read,
    .write    = ppp_asynctty_write,
    .ioctl    = ppp_asynctty_ioctl,
    .poll    = ppp_asynctty_poll,
    .receive_buf = ppp_asynctty_receive,
    .write_wakeup = ppp_asynctty_wakeup,
};

static int __init
ppp_async_init(void)
{
    /*注册tty规程*/
    err = tty_register_ldisc(N_PPP, &amp;ppp_ldisc);
}

/*创建channel*/
static int ppp_asynctty_open(struct tty_struct *tty)
{

}

static int ppp_asynctty_ioctl(struct tty_struct *tty, struct file *file,
           unsigned int cmd, unsigned long arg)
{
    switch (cmd) {
    case PPPIOCGCHAN:   //获取channel
    case PPPIOCGUNIT:   //
    case TCFLSH:
    case FIONREAD:
    }
}
</code></pre>
<h4 id="ppp框架中的-tty驱动层"><a href="#ppp框架中的-tty驱动层" class="headerlink" title="ppp框架中的(tty驱动层)"></a>ppp框架中的(tty驱动层)</h4><pre><code class="c">pty.c  
1、根据driver支持的最大设备数，申请n个 uart_state 空间，每一个 uart_state 都有一个 uart_port 。
2、分配一个 tty_driver ，并将drv-&gt;tty_driver 指向它。
3、对 tty_driver 进行设置，其中包括默认波特率、校验方式等，还有一个重要的 Ops ，uart_ops ，它是tty核心与我们串口驱动通信的接口。
4、初始化每一个 uart_state 的 tasklet 。
5、注册 tty_driver 。
pty_init()
{
    tty_set_operations(pty_driver, &amp;pty_ops);
    tty_register_driver(pty_driver);
}
</code></pre>
<p>​    </p>
<pre><code class="c">ppp_register_net_channel() {
    init_ppp_file(&amp;pch-&gt;file, CHANNEL);
}
ppp_create_interface(){
    init_ppp_file(&amp;ppp-&gt;file, INTERFACE);  
}
</code></pre>
<blockquote>
<p>ppp只需通过pptp知道一个tty_dev就可以了</p>
</blockquote>
<h3 id="pppd配置参数"><a href="#pppd配置参数" class="headerlink" title="pppd配置参数"></a>pppd配置参数</h3><h4 id="pppd相关fd"><a href="#pppd相关fd" class="headerlink" title="pppd相关fd"></a>pppd相关fd</h4><pre><code class="c">    /*/dev/pty/n 1.绑定规程 2.获取chindex 
    connect_tty中第二创建*/
    ppp_cfg[unit]-&gt;dev_fd = ppp_info-&gt;ttyfd; 

    /*/dev/ppp CHANNEL 
    pptp_setup_ppp中第三创建*/
    ppp_cfg[unit]-&gt;lcp_fd = fd;        

    /*/dev/ppp INTERFACE 
    make_ppp_unit中第一创建*/
    ppp_cfg[unit]-&gt;ppp_fd =  ppp_info-&gt;ppp_dev_fd;
</code></pre>
<p>​    之所以列出此结构,是因为ppp启动状态机之前的所有初始化都和此配置相关.</p>
<p>​    我们初始化时可以利用此结构依次初始化.</p>
<h4 id="pppd相关结构体"><a href="#pppd相关结构体" class="headerlink" title="pppd相关结构体"></a>pppd相关结构体</h4><pre><code class="c">/*我们自己定义用于保存ppp配置*/
struct pptp_ppp_channel
{
    int ppp_dev_fd;    
    int ifunit;            /* Interface unit number */
    int ioctl_fd;            /*for ioctl*/
    struct thread *cdma_rth;
    struct thread *cdma_idle_tth;
    struct thread *at_rth;
    struct thread *at_tth;
    struct thread *auto_down_dial;
    list pkt_list;
    int ttyfd;
    int state;
    char user[256];    /* Username for authentication */
    char passwd[256];    /* Password for authentication */
    struct prefix_ipv4 local_addr;
    u8     distance;
    u8     weight;
    u8     gateway;
    u8     dns;
    int idle_time;
};
/*pppd状态机用到的结构体*/
struct ppp_info
{
    int unit;
    int dev_fd;
    int lcp_fd;
    int ppp_fd;
    int remote_id;
    char    *user;    /* Username for authentication */
    char    *passwd;    /* Password for authentication */
    char *ifname;
    char attach_inter[16];
    unsigned char distance;
    unsigned char weight;
    unsigned char gateway;
    unsigned char dns;
    unsigned char auth;
    unsigned char auth_type;
    unsigned char down_flag;    
    unsigned int unique;
    unsigned int dns_value;
    unsigned int wins_value;
    char usergrp[MAXNAMELEN];
    struct prefix_ipv4 localaddr;
    unsigned int peer_address;//tunnip
    int lcp_detect_interval_time;        
    int lcp_detect_lost_times;        
    struct thread * lcp_thread;
    struct thread * ipcp_rthread;
    void *conn;
    void *priv_data;
    int natid;
    int mtu;
    Ppp_if_type iftype;
    int (*manage_auto_down) (char *ifname);
    int (*ipcp_up_cb) (struct ppp_cb_info *cb_info);
    int (*ipcp_down_cb) (struct ppp_cb_info *cb_info);
    int (*lcp_auth) (char *name, char *group, char *password, unsigned char *challenge, int unit, int type);
    int (*check_rqci)(__u32 addr);
};
</code></pre>
<h3 id="pppd协议初始化原理代码"><a href="#pppd协议初始化原理代码" class="headerlink" title="pppd协议初始化原理代码"></a>pppd协议初始化原理代码</h3><h4 id="pppd对tty做规程绑定"><a href="#pppd对tty做规程绑定" class="headerlink" title="pppd对tty做规程绑定"></a>pppd对tty做规程绑定</h4><pre><code class="c">/* The PPP discpline */
static int ppp_disc = N_PPP;    

int tty_establish_ppp (int devfd)
{
    /*绑定tty规程*/
    if (ioctl(devfd, TIOCSETD, &amp;ppp_disc) &lt; 0)
    ret_fd = generic_establish_ppp(devfd);
}
</code></pre>
<h4 id="pppd绑定对应pty-chindex"><a href="#pppd绑定对应pty-chindex" class="headerlink" title="pppd绑定对应pty_chindex"></a>pppd绑定对应pty_chindex</h4><pre><code class="c">//例
void start_link(unit)
{
    /*调用connect_tty*/
    devfd = the_channel-&gt;connect();
    /*调用tty_establish_ppp*/
    fd_ppp = the_channel-&gt;establish_ppp(devfd);
}

int connect_tty()
{
    /*char ppp_devnam[MAXPATHLEN]; //name of PPP tty*//
    get_pty(&amp;pty_master, &amp;pty_slave, ppp_devnam, uid);
    return pty_slave;
}

int tty_establish_ppp (int tty_fd)
{
    /*对tty做规程绑定*/
    if (ioctl(devfd, TIOCSETD, &amp;ppp_disc) &lt; 0)
    /*通过/dev/ppp设置channel*/
    ret_fd = generic_establish_ppp(tty_fd);
}
int generic_establish_ppp (int devfd)
{
    /*通过/dev/pty/n获取channel id*/
    if (ioctl(devfd, PPPIOCGCHAN, &amp;chindex) == -1)
    /*打开&quot;/dev/ppp&quot;*/
    fd = open(&quot;/dev/ppp&quot;, O_RDWR)
    /*设置channel 到/dev/ppp*/
    if (ioctl(fd, PPPIOCATTCHAN, &amp;chindex) &lt; 0)
}
</code></pre>
<h4 id="pppd协议发送接口初始化"><a href="#pppd协议发送接口初始化" class="headerlink" title="pppd协议发送接口初始化"></a>pppd协议发送接口初始化</h4><pre><code class="c">static int make_ppp_unit(struct cdma_ppp_channel *ppp_info)
{
    ppp_dev_fd = open(&quot;/dev/ppp&quot;, O_RDWR);
    x = ioctl(ppp_dev_fd, PPPIOCNEWUNIT, &amp;req);
      ppp_info-&gt;ppp_dev_fd = ppp_dev_fd;
}

int cdma_setup_ppp(struct cdma_ppp_channel *ppp_info)
{
      fd = open(&quot;/dev/ppp&quot;, O_RDWR);
    if (ioctl(fd, PPPIOCATTCHAN, &amp;chindex);
    if (ioctl(fd, PPPIOCCONNECT, &amp;ppp_info-&gt;ifunit);

    ppp_cfg[unit]-&gt;dev_fd = ppp_info-&gt;ttyfd;
    ppp_cfg[unit]-&gt;lcp_fd = fd;
    ppp_cfg[unit]-&gt;ppp_fd = ppp_info-&gt;ppp_dev_fd;
}

void output (int unit, unsigned char *p, int len)
{
  int fd = ppp_cfg[unit]-&gt;lcp_fd;

  if (ppp_cfg[unit]-&gt;ppp_fd &gt;= 0 &amp;&amp; !(proto &gt;= 0xc000 || proto == PPP_CCPFRAG))
        fd = ppp_cfg[unit]-&gt;ppp_fd;

  if (write(fd, p, len) &lt; 0)
}
</code></pre>
<h3 id="pppd协议-转状态机原理"><a href="#pppd协议-转状态机原理" class="headerlink" title="pppd协议/转状态机原理"></a>pppd协议/转状态机原理</h3><h4 id="pppd状态机框图"><a href="#pppd状态机框图" class="headerlink" title="pppd状态机框图"></a>pppd状态机框图</h4><p><img src="ppp状态机.jpeg" alt=""></p>
<p><img src="ppp协商.jpeg" alt=""></p>
<h4 id="pppd状态机启动代码"><a href="#pppd状态机启动代码" class="headerlink" title="pppd状态机启动代码"></a>pppd状态机启动代码</h4><pre><code class="c">int cdma_setup_ppp(struct cdma_ppp_channel *ppp_info){
    magic_init();
    for (i = 0; (protp = protocols[i]) != NULL; ++i)
        (*protp-&gt;init)(unit);
    new_phase(unit,PHASE_ESTABLISH);
    lcp_lowerup(unit);
    lcp_open(unit);        /* Start protocol */
    ppp_cfg[unit]-&gt;lcp_thread = thread_add_read(master, pppd_read, (void *)unit, fd);
    ppp_cfg[unit]-&gt;ipcp_rthread = thread_add_read(master, pppd_read, (void *)unit,  ppp_info-&gt;ppp_dev_fd);
}
</code></pre>
<h4 id="pppd协议发包流程"><a href="#pppd协议发包流程" class="headerlink" title="pppd协议发包流程"></a>pppd协议发包流程</h4><pre><code class="c">//ppp_generic.c
//ppp_xmit_process 通过虚拟网口
//ppp_channel_push 通过tty

switch (cmd) {
case PPPIOCNEWUNIT:
ppp = ppp_create_interface(net, unit, &amp;err);
file-&gt;private_data = &amp;ppp-&gt;file;
}
ppp_write(){
struct ppp_file *pf = file-&gt;private_data;
switch (pf-&gt;kind) {
case INTERFACE:
    ppp_xmit_process(PF_TO_PPP(pf));
    break;
case CHANNEL:
    ppp_channel_push(PF_TO_CHANNEL(pf));
    break;
}
</code></pre>
<h4 id="虚拟网口发包流程"><a href="#虚拟网口发包流程" class="headerlink" title="虚拟网口发包流程"></a>虚拟网口发包流程</h4><pre><code>ppp_start_xmit-&gt;ppp_xmit_process-&gt;
ppp_push调用pch-&gt;chan-&gt;ops-&gt;start_xmit发送数据包。    
ppp_asynctty_open中注册的ppp_async_send函数，    
---规程层---
ppp_async_send经ppp_async_push函数调用
tty-&gt;driver-&gt;write把数据发送串口
---驱动层---
pty_ops
</code></pre><p>例如:tty-&gt;driver-&gt;write为pty_ops中的write   </p>
<pre><code class="c">//注:其中pty-master可以理解为tty硬件层
//内核中pty.c 设置驱动层操作函数
pty_init()
{
    tty_set_operations(pty_driver, &amp;pty_ops);
}
//pppd为以上pty和disc做了绑定
//也就是驱动层到规程层关联
int tty_establish_ppp (int devfd)
{
    /*绑定tty规程*/
    if (ioctl(devfd, TIOCSETD, &amp;ppp_disc) &lt; 0)
    ret_fd = generic_establish_ppp(devfd);
}
//其中channel_id为以上操作标识
</code></pre>
<h4 id="ppp-channel-push-PF-TO-CHANNEL-pf"><a href="#ppp-channel-push-PF-TO-CHANNEL-pf" class="headerlink" title="ppp_channel_push(PF_TO_CHANNEL(pf))"></a>ppp_channel_push(PF_TO_CHANNEL(pf))</h4><pre><code>        ppp = ppp_create_interface(net, unit, &amp;err);
        if (!ppp)
            break;
        file-&gt;private_data = &amp;ppp-&gt;file;
</code></pre><h4 id="ppp-xmit-process-PF-TO-PPP-pf"><a href="#ppp-xmit-process-PF-TO-PPP-pf" class="headerlink" title="ppp_xmit_process(PF_TO_PPP(pf))"></a>ppp_xmit_process(PF_TO_PPP(pf))</h4><pre><code>        ppp = ppp_create_interface(net, unit, &amp;err);
        if (!ppp)
            break;
        file-&gt;private_data = &amp;ppp-&gt;file;
</code></pre><p>ppp_设置网口ip</p>
<h2 id="pptp原理与设计"><a href="#pptp原理与设计" class="headerlink" title="pptp原理与设计"></a>pptp原理与设计</h2><p>值得一提的是 ppp的LCP协商Configure-Request,是在pptp中发的.</p>
<pre><code class="c">数据结构:
pptp_cfg
{
    int instance_id;
    int gre_fd;
    int tty_fd;
    int call_id;
    int peer_call_id;
    char username[];
    char password[];
}
操作函数:
启动
1. 创建gre_fd
2. 创建tty_fd;
3. 通过pptp协商获取call_id
4. 启动gre_copy线程
5. 执行ppp协商,创建虚拟接口
关闭
1. 协商断开ppp连接, 协商断开pptp连接.
2. 关闭虚拟接口
2. gre_copy通过pptp_cfg标记退出线程并释放对应pptp_cfg
</code></pre>
<h2 id="PPTP模块简易软件设计"><a href="#PPTP模块简易软件设计" class="headerlink" title="PPTP模块简易软件设计"></a>PPTP模块简易软件设计</h2><ol>
<li>改造PPTP</li>
<li>初始化PPPD相关设置</li>
<li>启动PPPD状态机</li>
</ol>
<h2 id="PPTP软件设计方案"><a href="#PPTP软件设计方案" class="headerlink" title="PPTP软件设计方案"></a>PPTP软件设计方案</h2><h3 id="多实例原理与设计"><a href="#多实例原理与设计" class="headerlink" title="多实例原理与设计"></a>多实例原理与设计</h3><p>考虑多实例, 可以把每个实例运行一个线程. </p>
<ol>
<li><p>多线程问题,就要考虑:<br><strong>全局变量</strong> <strong>互斥条件</strong> <strong>执行顺序</strong> <strong>信号</strong> 等.<br>pptp 本身是多进程实现多个连接,<br>所以想要多线程实现多个连接, 还需解决变量问题.  </p>
</li>
<li><p>也可以用多进程实现多实例<br>但是又要考虑控制进程时,需要进程间通信.  </p>
</li>
<li><p>多进程合并为线程和合并pppd需要考虑信号, 输入输出等问题.</p>
</li>
</ol>
<p>pptp 完成二层点对点通道<br>ppp 完成三层ip通道</p>
<p>一. 完成pppd和pptp的整合, 使pptp可以和pppd.a编译在一起运行.  </p>
<pre><code>    1.分析pppd原理.  
        包含:pppd 利用/dev/ppp0字符设备,通过内核到pptp_gre. 
        这需要分析内核的实现.  
    2.分析pptp原理.
</code></pre><p>二. 完成pptp初始化和二层点对点环境的建立.</p>
<p>三. 完成cli的demon融合</p>
<p>接口描述：</p>
<pre><code>pptp_init    : 1.初始化pptp默认参数 2.开启ctrl
pptp_set     : 1.设置定制参数 
pptp_enable : 1. Ctrl连接, Gre隧道建立, 获取call_id
              2. 开启ppp任务, 开启copy功能任务
pptp_disable: 1. 关闭ppp任务, 关闭copy功能 
</code></pre><pre><code>1. Ctrl连接, Gre隧道断开任务
     pppd通过字符设备/dev/ppp 和内核通信和发送协商报文
</code></pre><p>通过以上字符设备实现,发现ppp内核字符设备就一个.<br>如果要多个要注册多个ppp字符设备.<br>并且发送协商报文出口是在字符设备的私有数据段中.</p>
<p>pppd主要完成功能:<br>1.链路协商<br>2.创建虚拟接口</p>
<p>链路协商需要提供:</p>
<p>创建虚拟接口提供:</p>
<p>pppd输入: 1.pptp参数 2.pptp协商后信息<br>pppd输出: 1.设置虚拟接口</p>
<ol>
<li>其中启动ppp任务,pptp需要传入tty_fd相关信息</li>
</ol>
<p>pppd接口 </p>
<ol>
<li>l2tp_setup_pppd</li>
<li>establlish_session</li>
</ol>
<p>pppd所有配置参数</p>
<pre><code class="c">typedef struct {
    char    *name;        /* name of the option */
    enum opt_type type;
    void    *addr;
    char    *description;
    unsigned int flags;
    void    *addr2;
    int    upper_limit;
    int    lower_limit;
    const char *source;
    short int priority;
    short int winner;
} option_t;
</code></pre>
<p>pppd中的ppp_main.c<br>中的main函数改为ppp_setup只是避免main冲突和做参考,并没有用.</p>
<p>真正的pppd启动函数在l2tp中模仿之前的main函数改为l2pd_pppox.c中<strong>l2tp_setup_pppd</strong></p>
<p>l2tp_peer 是用来和对端通信的接口</p>
<p>ppp_ioctl  配置了ppp_channel *chan<br>ppp_write  </p>
<p>移植<br>l2tp_ppp(sync_pppd) -&gt; pptp_ppp<br>l2tp_pppox -&gt; pptp_pppox   </p>
<h3 id="命令行原理与设计"><a href="#命令行原理与设计" class="headerlink" title="命令行原理与设计"></a>命令行原理与设计</h3><p>如果需要多实例,则全局pptp配置连接 pptp守护进程.</p>
<p>守护进程只负责创建实例删除实例.</p>
<h3 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h3><h4 id="第一阶段-开源验证"><a href="#第一阶段-开源验证" class="headerlink" title="第一阶段: 开源验证"></a>第一阶段: 开源验证</h4><p>​    实现pptp, pppd分离启动<br>​    /<em>唯一需要修改的是pptp在pty_read地方,<br>​    发现pppd为启动则continue</em>/<br>​    pptp 和pppd 开源独立测试<br>​    ./pptp 192.168.2.12<br>​    ./pppd /dev/pts/2 unit 1 user test@hfdzzp.vpdn.zj password test135</p>
<h4 id="第二阶段-简单demo"><a href="#第二阶段-简单demo" class="headerlink" title="第二阶段: 简单demo"></a>第二阶段: 简单demo</h4><p>​    实现pptp融合我们系统中的pppd库<br>​    /<em>实现简单的demo, 只是能ping通即可</em>/<br>​    /<em>在测试中发现 必须以协议的方式下发ip,<br>​    不能以以下方式设置,还不知道有何区别</em>/<br>​    ifconfig pptp0 up<br>​    ifconfig pptp0 192.168.210.10   //此方法配置ip不可行 必须以api的方式配置<br>​    route add -net 192.168.210.0 netmask 255.255.255.0 pptp0</p>
<h4 id="第三阶段-设计方案"><a href="#第三阶段-设计方案" class="headerlink" title="第三阶段: 设计方案"></a>第三阶段: 设计方案</h4><p>​    继续分析ppp相关代码,实现优化方案</p>
<p>​    多实例?</p>
<h4 id="第四阶段-实现代码"><a href="#第四阶段-实现代码" class="headerlink" title="第四阶段: 实现代码"></a>第四阶段: 实现代码</h4><h4 id="第五阶段-测试功能"><a href="#第五阶段-测试功能" class="headerlink" title="第五阶段: 测试功能"></a>第五阶段: 测试功能</h4><h2 id="还未掌握内容"><a href="#还未掌握内容" class="headerlink" title="还未掌握内容"></a>还未掌握内容</h2><ol>
<li>unit /channel_id / struct ppp /struct ppp_file 等千丝万缕的关系.</li>
</ol>
<p>pppd初始化流程start_link</p>
<p>第一步: 通过connect_tty拿到pty_client_fd</p>
<p>第二步: 通过tty_establish_ppp做规程绑定</p>
<p>callmgr_main-&gt;pptp_dispatch-&gt;pptp_handle_timer</p>
<p>断开后 应该退出pptp_ctrl进程 和 ppp线程</p>
<p>断开重连 应该再次pptp协商 和ppp协商</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考:"></a>参考:</h2><p>​    <a href="http://blog.csdn.net/lizuobin2/article/details/51773305" target="_blank" rel="external">tty初探—uart驱动框架分析</a></p>
<p>​    <a href="http://blog.csdn.net/wt0427/article/details/7761163" target="_blank" rel="external">Linux PPP详细介绍</a></p>
<p>​    <a href="http://linux.chinaunix.net/techdoc/system/2008/11/07/1043935.shtml" target="_blank" rel="external">Linux PPP 数据收发流程</a></p>

        </div>
        
          


  <section class='meta' id="footer-meta">
    <hr>
    <div class='new-meta-box'>
      
        
          <div class="new-meta-item date" itemprop="dateUpdated" datetime="2017-10-23T16:58:51+08:00">
  <a class='notlink'>
    <i class="fas fa-clock" aria-hidden="true"></i>
    <p>最后更新于 2017年10月23日</p>
  </a>
</div>

        
      
        
          

        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="QQ好友" rel="external nofollow noopener noreferrer"
          
          href="http://connect.qq.com/widget/shareqq/index.html?url=http://demonelf.github.io/NETWORK/4G路由器移植pptp方案总结.html&title=4G路由器移植pptp方案总结 | 芯机智&summary="
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/qq.png">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="QQ空间" rel="external nofollow noopener noreferrer"
          
          href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://demonelf.github.io/NETWORK/4G路由器移植pptp方案总结.html&title=4G路由器移植pptp方案总结 | 芯机智&summary="
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/qzone.png">
          
        </a>
      
    
      
        <a class="-mob-share-weibo" title="微博" rel="external nofollow noopener noreferrer"
          
          href="http://service.weibo.com/share/share.php?url=http://demonelf.github.io/NETWORK/4G路由器移植pptp方案总结.html&title=4G路由器移植pptp方案总结 | 芯机智&summary="
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/weibo.png">
          
        </a>
      
    
  </div>
</div>



        
      
    </div>
  </section>


        
        
            <div class="prev-next">
                
                    <section class="prev">
                        <span class="art-item-left">
                            <h6><i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;上一页</h6>
                            <h4>
                                <a href="/DEVELOP/pty示例代码.html" rel="prev" title="pty示例代码">
                                  
                                      pty示例代码
                                  
                                </a>
                            </h4>
                            
                        </span>
                    </section>
                
                
                    <section class="next">
                        <span class="art-item-right" aria-hidden="true">
                            <h6>下一页&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i></h6>
                            <h4>
                                <a href="/NETWORK/Linux PPP 框架分析.html" rel="prev" title="Linux PPP 框架分析">
                                    
                                        Linux PPP 框架分析
                                    
                                </a>
                            </h4>
                            
                        </span>
                    </section>
                
            </div>
        
      </section>
    </article>
  

  
    <!-- 显示推荐文章和评论 -->



  


  




<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: '4G路由器移植pptp方案总结',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
    
    
      
        
          
          
            <section class='widget author'>
  <div class='content pure'>
    
      <div class='avatar'>
        <img class='avatar' src='http://bbs.dnsnat.com/discuz/uc_server/data/avatar/000/00/00/01_avatar_big.jpg'/>
      </div>
    
    
    
      <div class="social-wrapper">
        
          
            <a href="/atom.xml"
              class="social fas fa-rss flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="mailto:me@xaoxuu.com"
              class="social fas fa-envelope flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://github.com/xaoxuu"
              class="social fab fa-github flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://music.163.com/#/user/home?id=63035382"
              class="social fas fa-headphones-alt flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
      </div>
    
  </div>
</section>

          
        
      
        
          
          
            
  <section class='widget toc-wrapper'>
    
<header class='pure'>
  <div><i class="fas fa-list fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;本文目录</div>
  
    <div class='wrapper'><a class="s-toc rightBtn" rel="external nofollow noopener noreferrer" href="javascript:void(0)"><i class="fas fa-thumbtack fa-fw"></i></a></div>
  
</header>

    <div class='content pure'>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#概览"><span class="toc-text">概览</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pppoe总框架原理"><span class="toc-text">pppoe总框架原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pptp总框架原理"><span class="toc-text">pptp总框架原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ppp可行性分析"><span class="toc-text">ppp可行性分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#本文介绍"><span class="toc-text">本文介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#难点"><span class="toc-text">难点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tty简介"><span class="toc-text">tty简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ppp内核态tty框架实现代码"><span class="toc-text">ppp内核态tty框架实现代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ppp内核态重要结构体"><span class="toc-text">ppp内核态重要结构体</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pppd摘要代码框架"><span class="toc-text">pppd摘要代码框架</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ppp框架中的-tty用户层"><span class="toc-text">ppp框架中的(tty用户层)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ppp框架中的-tty核心层"><span class="toc-text">ppp框架中的(tty核心层)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ppp框架中的-tty规程层"><span class="toc-text">ppp框架中的(tty规程层)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ppp框架中的-tty驱动层"><span class="toc-text">ppp框架中的(tty驱动层)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pppd配置参数"><span class="toc-text">pppd配置参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pppd相关fd"><span class="toc-text">pppd相关fd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pppd相关结构体"><span class="toc-text">pppd相关结构体</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pppd协议初始化原理代码"><span class="toc-text">pppd协议初始化原理代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pppd对tty做规程绑定"><span class="toc-text">pppd对tty做规程绑定</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pppd绑定对应pty-chindex"><span class="toc-text">pppd绑定对应pty_chindex</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pppd协议发送接口初始化"><span class="toc-text">pppd协议发送接口初始化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pppd协议-转状态机原理"><span class="toc-text">pppd协议/转状态机原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pppd状态机框图"><span class="toc-text">pppd状态机框图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pppd状态机启动代码"><span class="toc-text">pppd状态机启动代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pppd协议发包流程"><span class="toc-text">pppd协议发包流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#虚拟网口发包流程"><span class="toc-text">虚拟网口发包流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ppp-channel-push-PF-TO-CHANNEL-pf"><span class="toc-text">ppp_channel_push(PF_TO_CHANNEL(pf))</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ppp-xmit-process-PF-TO-PPP-pf"><span class="toc-text">ppp_xmit_process(PF_TO_PPP(pf))</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pptp原理与设计"><span class="toc-text">pptp原理与设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PPTP模块简易软件设计"><span class="toc-text">PPTP模块简易软件设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PPTP软件设计方案"><span class="toc-text">PPTP软件设计方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#多实例原理与设计"><span class="toc-text">多实例原理与设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#命令行原理与设计"><span class="toc-text">命令行原理与设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实现方案"><span class="toc-text">实现方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#第一阶段-开源验证"><span class="toc-text">第一阶段: 开源验证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第二阶段-简单demo"><span class="toc-text">第二阶段: 简单demo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第三阶段-设计方案"><span class="toc-text">第三阶段: 设计方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第四阶段-实现代码"><span class="toc-text">第四阶段: 实现代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#第五阶段-测试功能"><span class="toc-text">第五阶段: 测试功能</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#还未掌握内容"><span class="toc-text">还未掌握内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-text">参考:</span></a></li></ol>
    </div>
  </section>


          
        
      
        
          
          
            <section class='widget grid'>
  
<header class='pure'>
  <div><i class="fas fa-map-signs fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;站内导航</div>
  
</header>

  <div class='content pure'>
    <ul class="grid navgation">
      
        <li><a class="flat-box" title="/" href="/"
          
          
          id="home">
          
            <i class="fas fa-clock fa-fw" aria-hidden="true"></i>
          
          近期文章
        </a></li>
      
        <li><a class="flat-box" title="/blog/archives/" href="/blog/archives/"
          
            rel="nofollow"
          
          
          id="blogarchives">
          
            <i class="fas fa-archive fa-fw" aria-hidden="true"></i>
          
          文章归档
        </a></li>
      
        <li><a class="flat-box" title="/projects/" href="/projects/"
          
          
          id="projects">
          
            <i class="fas fa-code-branch fa-fw" aria-hidden="true"></i>
          
          开源项目
        </a></li>
      
        <li><a class="flat-box" title="/friends/" href="/friends/"
          
            rel="nofollow"
          
          
          id="friends">
          
            <i class="fas fa-link fa-fw" aria-hidden="true"></i>
          
          我的友链
        </a></li>
      
        <li><a class="flat-box" title="https://xaoxuu.com/wiki/material-x/" href="https://xaoxuu.com/wiki/material-x/"
          
            rel="nofollow"
          
          
          id="https:xaoxuu.comwikimaterial-x">
          
            <i class="fas fa-book fa-fw" aria-hidden="true"></i>
          
          主题文档
        </a></li>
      
        <li><a class="flat-box" title="/about/" href="/about/"
          
            rel="nofollow"
          
          
          id="about">
          
            <i class="fas fa-info-circle fa-fw" aria-hidden="true"></i>
          
          关于小站
        </a></li>
      
    </ul>
  </div>
</section>

          
        
      
        
          
          
            
  <section class='widget category'>
    
<header class='pure'>
  <div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;文章分类</div>
  
    <a class="rightBtn"
    
      rel="nofollow"
    
    
    href="/blog/categories/"
    title="blog/categories/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content pure'>
      <ul class="entry">
        
          <li><a class="flat-box" title="/categories/DEVELOP/" href="/categories/DEVELOP/"><div class='name'>DEVELOP</div><div class='badge'>(4)</div></a></li>
        
          <li><a class="flat-box" title="/categories/EMBEDDED/" href="/categories/EMBEDDED/"><div class='name'>EMBEDDED</div><div class='badge'>(95)</div></a></li>
        
          <li><a class="flat-box child" title="/categories/EMBEDDED/mini2440/" href="/categories/EMBEDDED/mini2440/"><div class='name'>mini2440</div><div class='badge'>(3)</div></a></li>
        
          <li><a class="flat-box" title="/categories/LIVE/" href="/categories/LIVE/"><div class='name'>LIVE</div><div class='badge'>(3)</div></a></li>
        
          <li><a class="flat-box" title="/categories/NETWORK/" href="/categories/NETWORK/"><div class='name'>NETWORK</div><div class='badge'>(12)</div></a></li>
        
          <li><a class="flat-box" title="/categories/SYSTEM/" href="/categories/SYSTEM/"><div class='name'>SYSTEM</div><div class='badge'>(12)</div></a></li>
        
          <li><a class="flat-box" title="/categories/VPN系列之五花八门/" href="/categories/VPN系列之五花八门/"><div class='name'>VPN系列之五花八门</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box" title="/categories/arm/" href="/categories/arm/"><div class='name'>arm</div><div class='badge'>(0)</div></a></li>
        
          <li><a class="flat-box" title="/categories/embedded/" href="/categories/embedded/"><div class='name'>embedded</div><div class='badge'>(0)</div></a></li>
        
          <li><a class="flat-box" title="/categories/linux/" href="/categories/linux/"><div class='name'>linux</div><div class='badge'>(0)</div></a></li>
        
          <li><a class="flat-box" title="/categories/笑看人生/" href="/categories/笑看人生/"><div class='name'>笑看人生</div><div class='badge'>(0)</div></a></li>
        
      </ul>
    </div>
  </section>


          
        
      
        
          
          
            

          
        
      
        
          
          
            


  <section class='widget music'>
    
<header class='pure'>
  <div><i class="fas fa-compact-disc fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;最近在听</div>
  
    <a class="rightBtn"
    
      rel="external nofollow noopener noreferrer"
    
    
      target="_blank"
    
    href="https://music.163.com/#/user/home?id=63035382"
    title="https://music.163.com/#/user/home?id=63035382">
    <i class="far fa-heart fa-fw"></i></a>
  
</header>

    <div class='content pure'>
      
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.7.0/dist/APlayer.min.css">
  <div class="aplayer"
    data-theme="#1BCDFC"
    
    
    data-mode="circulation"
    data-server="netease"
    data-type="playlist"
    data-id="2615636388"
    data-volume="0.7">
  </div>
  <script src="https://cdn.jsdelivr.net/npm/aplayer@1.7.0/dist/APlayer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/meting@1.1.0/dist/Meting.min.js"></script>


    </div>
  </section>


          
        
      
    

  
</aside>

<footer id="footer" class="clearfix">
  
  
    <div class="social-wrapper">
      
        
          <a href="/atom.xml"
            class="social fas fa-rss flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="mailto:me@xaoxuu.com"
            class="social fas fa-envelope flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://github.com/xaoxuu"
            class="social fab fa-github flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://music.163.com/#/user/home?id=63035382"
            class="social fas fa-headphones-alt flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
    </div>
  
  <br>
  <div><p>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
  <div>
    本站使用
    <a href="https://xaoxuu.com/wiki/material-x/" target="_blank" class="codename">Material X</a>
    作为主题
    
      ，
      总访问量为
      <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
      次
    
    。
  </div>
</footer>
<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>

  <script>
    var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
    var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
    var ALGOLIA_API_KEY = "";
    var ALGOLIA_APP_ID = "";
    var ALGOLIA_INDEX_NAME = "";
    var AZURE_SERVICE_NAME = "";
    var AZURE_INDEX_NAME = "";
    var AZURE_QUERY_KEY = "";
    var BAIDU_API_ID = "";
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/"||"/";
    if(!ROOT.endsWith('/'))ROOT += '/';
  </script>

<script src="//instant.page/1.2.2" type="module" integrity="sha384-2xV8M5griQmzyiY3CDqh1dn4z3llDVqZDqzjzcY+jCBCk/a5fXJmuZ/40JJAPeoU"></script>


  <script async src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      const $reveal = $('.reveal');
      if ($reveal.length === 0) return;
      const sr = ScrollReveal({ distance: 0 });
      sr.reveal('.reveal');
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>




  
  
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js"></script>
    <script type="text/javascript">
      $(function(){
        if ('.cover') {
          $('.cover').backstretch(
          ["https://img.vim-cn.com/6d/a0c9e6f9efad8b731cb7376504bd10d79d2053.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        } else {
          $.backstretch(
          ["https://img.vim-cn.com/6d/a0c9e6f9efad8b731cb7376504bd10d79d2053.jpg"],
          {
            duration: "6000",
            fade: "2500"
          });
        }
      });
    </script>
  











  <script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.8/js/app.js"></script>


  <script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-material-x@19.8/js/search.js"></script>




<!-- 复制 -->
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  let COPY_SUCCESS = "复制成功";
  let COPY_FAILURE = "复制失败";
  /*页面载入完成后，创建复制按钮*/
  !function (e, t, a) {
    /* code */
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '  <i class="fa fa-copy"></i><span>复制</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });

      clipboard.on('success', function(e) {
        //您可以加入成功提示
        console.info('Action:', e.action);
        console.info('Text:', e.text);
        console.info('Trigger:', e.trigger);
        success_prompt(COPY_SUCCESS);
        e.clearSelection();
      });
      clipboard.on('error', function(e) {
        //您可以加入失败提示
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
        fail_prompt(COPY_FAILURE);
      });
    }
    initCopyCode();

  }(window, document);

  /**
   * 弹出式提示框，默认1.5秒自动消失
   * @param message 提示信息
   * @param style 提示样式，有alert-success、alert-danger、alert-warning、alert-info
   * @param time 消失时间
   */
  var prompt = function (message, style, time)
  {
      style = (style === undefined) ? 'alert-success' : style;
      time = (time === undefined) ? 1500 : time*1000;
      $('<div>')
          .appendTo('body')
          .addClass('alert ' + style)
          .html(message)
          .show()
          .delay(time)
          .fadeOut();
  };

  // 成功提示
  var success_prompt = function(message, time)
  {
      prompt(message, 'alert-success', time);
  };

  // 失败提示
  var fail_prompt = function(message, time)
  {
      prompt(message, 'alert-danger', time);
  };

  // 提醒
  var warning_prompt = function(message, time)
  {
      prompt(message, 'alert-warning', time);
  };

  // 信息提示
  var info_prompt = function(message, time)
  {
      prompt(message, 'alert-info', time);
  };

</script>


<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>





  <script>setLoadingBarProgress(100);</script>
</body>
</html>
