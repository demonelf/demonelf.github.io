---
title: 路由下一跳与出站接口区别
id: 778
comment: false
categories:
  - arm
date: 2016-07-07 19:27:52
tags:
---

<span style="color:#333333; font-size:10pt"><span style="font-family:宋体; background-color:white">用出站接口，意思就是去往指定目标网络从这个接口丢出去，适用于点到点网络，和</span><span style="font-family:Times New Roman; background-color:white">ARP</span><span style="font-family:宋体; background-color:white">无关，点到点网络本身是可以不需要地址的。除了你就是我，除了我就是，你要不要地址、寻址根本没什么意思。所以用出站接口写静态路由，路由表里显示的是直连。</span><span style="font-family:Times New Roman; background-color:white">

<!-- more -->
</span><span style="font-family:宋体; background-color:white">    用下一跳</span><span style="font-family:Times New Roman; background-color:white">IP</span><span style="font-family:宋体; background-color:white">地址，下一跳</span><span style="font-family:Times New Roman; background-color:white">IP</span><span style="font-family:宋体; background-color:white">地址，叫递归静态路由，路由器在转发数据包到目标网络的时候，首先要先解析下一跳的可达性，换句话说总共要解析两次，从转发效率上来说低于直连静态路由</span><span style="font-family:Times New Roman; background-color:white">(</span><span style="font-family:宋体; background-color:white">用出站口</span><span style="font-family:Times New Roman; background-color:white">)</span><span style="font-family:宋体; background-color:white">。递归静态路由一般用在多路访问环境，所以下一跳理论上来说必须指定一个</span><span style="font-family:Times New Roman; background-color:white">IP</span><span style="font-family:宋体; background-color:white">地址，不能像点到点那样随便乱丢包。</span><span style="font-family:Times New Roman; background-color:white">

</span><span style="font-family:宋体; background-color:white">   现在的新问题是，按照这个原理，我们在以太网上做静态路由的时候，为什么下一跳指定出站接口，路由器依然知道如何转发数据包呢？按照我们刚才讲的理论，在多路访问环境下如果用出站接口做静态路由，路由器应该不知道下一跳是谁才对。这是为什么呢？</span><span style="font-family:Times New Roman; background-color:white">
</span></span><span style="font-family:宋体; font-size:12pt">
		</span>

<span style="color:#333333; font-size:10pt"><span style="font-family:Arial">     </span><span style="font-family:宋体">答案是代理</span><span style="font-family:Arial">ARP</span><span style="font-family:宋体">。但是这样做也有很大的缺点，就是说理论上本机最多会产生</span><span style="font-family:Arial">2^32</span><span style="font-family:宋体">条</span><span style="font-family:Arial">ARP</span><span style="font-family:宋体">缓存，相当消耗内存。所以多路访问环境不建议使用直连静态路由，建议采用递归静态路由。</span><span style="font-family:Arial">
			</span></span>

<span style="color:#333333; font-size:10pt"><span style="font-family:Arial">   </span><span style="font-family:宋体">在配置静态路由时，即可指定接口，也可指定下一跳。使不同的网段的主机通信，到底采用哪种方法，需要根据实际情况而定，在点到点的网络环境中，无论是指定下一跳地址还是接口地址，其效果都一样。但是在广播网络环境下，指定下一跳地址或接口地址就会起到不同的效果，如果指定为接口地址的话，那么不管数据包的目标地址是否有效，每次数据包到达时都会触发一个</span><span style="font-family:Arial">ARP</span><span style="font-family:宋体">请求，又因为</span><span style="font-family:Arial">ARP</span><span style="font-family:宋体">代理在[</span><span style="color:#df3434"><span style="font-family:Arial; text-decoration:underline">**iOS**</span><span style="color:#333333"><span style="font-family:宋体">环境下默认是打开的，这意味着路由器需要配备大量的</span><span style="font-family:Arial">ARP</span><span style="font-family:宋体">高速缓存，而如果指定为下一跳地址的话，仅当第一个去往目的地址的数据包到达时才会触发</span><span style="font-family:Arial">ARP</span><span style="font-family:宋体">请求。</span><span style="font-family:Arial">
					</span></span></span></span>

<span style="color:#006699"><span style="font-family:宋体; font-size:13pt">网关和接口确定过程</span><span style="color:#333333; font-family:Arial; font-size:10pt">
			</span></span>

<span style="color:#333333; font-size:10pt"><span style="font-family:宋体">在确定使用的路由项后，网关和接口通过以下方式确定：</span><span style="font-family:Arial">
			</span></span>

*   <div style="background: white"><span style="color:#333333; font-size:10pt"><span style="font-family:宋体">如果路由项中的网关地址为空或者为本地计算机上的某个网络接口，那么在发送数据包时：</span><span style="font-family:Arial">
					</span></span></div>

        *   <div style="background: white"><span style="color:#333333; font-size:10pt"><span style="font-family:宋体">通过路由项中对应的网络接口发送；</span><span style="font-family:Arial">
							</span></span></div>
    *   <div style="background: white"><span style="color:#333333; font-size:10pt"><span style="font-family:宋体">源</span><span style="font-family:Verdana">IP</span><span style="font-family:宋体">地址为此网络接口的</span><span style="font-family:Verdana">IP</span><span style="font-family:宋体">地址；</span><span style="font-family:Arial">
							</span></span></div>
    *   <div style="background: white"><span style="color:#333333; font-size:10pt"><span style="font-family:宋体">源</span><span style="font-family:Verdana">MAC</span><span style="font-family:宋体">地址为此网络接口的</span><span style="font-family:Verdana">MAC</span><span style="font-family:宋体">地址；</span><span style="font-family:Arial">
							</span></span></div>
    *   <div style="background: white"><span style="color:#333333; font-size:10pt"><span style="font-family:宋体">目的</span><span style="font-family:Verdana">IP</span><span style="font-family:宋体">地址为接收此数据包的目的主机的</span><span style="font-family:Verdana">IP</span><span style="font-family:宋体">地址；</span><span style="font-family:Arial">
							</span></span></div>
    *   <div style="background: white"><span style="color:#333333; font-size:10pt">**<span style="font-family:宋体">目的</span><span style="font-family:Verdana">MAC</span><span style="font-family:宋体">地址为接收此数据包的目的主机的</span><span style="font-family:Verdana">MAC</span><span style="font-family:宋体">地址；</span>**<span style="font-family:Arial">
							</span></span></div>
*   <div style="background: white"><span style="color:#333333; font-size:10pt"><span style="font-family:宋体">如果路由项中的网关地址并不属于本地计算机上的任何网络接口，那么在发送数据包时：</span><span style="font-family:Arial">
					</span></span></div>

        *   <div style="background: white"><span style="color:#333333; font-size:10pt"><span style="font-family:宋体">通过路由项中对应的网络接口发送；</span><span style="font-family:Arial">
							</span></span></div>
    *   <div style="background: white"><span style="color:#333333; font-size:10pt"><span style="font-family:宋体">源</span><span style="font-family:Verdana">IP</span><span style="font-family:宋体">地址为路由项中对应网络接口的</span><span style="font-family:Verdana">IP</span><span style="font-family:宋体">地址；</span><span style="font-family:Arial">
							</span></span></div>
    *   <div style="background: white"><span style="color:#333333; font-size:10pt"><span style="font-family:宋体">源</span><span style="font-family:Verdana">MAC</span><span style="font-family:宋体">地址路由项中对应网络接口的</span><span style="font-family:Verdana">MAC</span><span style="font-family:宋体">地址；</span><span style="font-family:Arial">
							</span></span></div>
    *   <div style="background: white"><span style="color:#333333; font-size:10pt"><span style="font-family:宋体">目的</span><span style="font-family:Verdana">IP</span><span style="font-family:宋体">地址为接收此数据包的目的主机的</span><span style="font-family:Verdana">IP</span><span style="font-family:宋体">地址；</span><span style="font-family:Arial">
							</span></span></div>
    *   <div style="background: white"><span style="color:#333333; font-size:10pt">**<span style="font-family:宋体">目的</span><span style="font-family:Verdana">MAC</span><span style="font-family:宋体">地址为网关的</span><span style="font-family:Verdana">MAC</span><span style="font-family:宋体">地址；</span>**<span style="font-family:Arial">
							</span></span></div>

<span style="color:#333333; font-size:10pt"><span style="font-family:宋体">在此以上面的路由表为基础，举例进行说明：</span><span style="font-family:Arial">
			</span></span>

<a href="http://wdqfirst.blog.163.com/blog/static/113347411201122825221701/"><span style="color:#336699; font-family:Verdana; font-size:10pt; text-decoration:underline">http://wdqfirst.blog.163.com/blog/static/113347411201122825221701/</span>](http://lib.csdn.net/base/1 "Swift知识库")<span style="color:#333333; font-family:Arial; font-size:10pt">
		</span>

*   <div style="background: white"><span style="color:#333333; font-size:10pt"><span style="font-family:宋体">和单播</span><span style="font-family:Verdana">IP</span><span style="font-family:宋体">地址</span><span style="font-family:Verdana"> 192.168.1.8 </span><span style="font-family:宋体">的通信：在进行相与计算时，</span><span style="font-family:Verdana">1</span><span style="font-family:宋体">、</span><span style="font-family:Verdana">3 </span><span style="font-family:宋体">项匹配，但是</span><span style="font-family:Verdana">3</span><span style="font-family:宋体">项为最长匹配路由，因此选择</span><span style="font-family:Verdana">3</span><span style="font-family:宋体">项。</span><span style="font-family:Verdana">3</span><span style="font-family:宋体">项的网关地址为本地计算机的网络接口</span><span style="font-family:Verdana">192.168.1.6</span><span style="font-family:宋体">，因此发送数据包时，目的</span><span style="font-family:Verdana">IP</span><span style="font-family:宋体">地址为</span><span style="font-family:Verdana"> 192.168.1.8</span><span style="font-family:宋体">、目的</span><span style="font-family:Verdana">MAC</span><span style="font-family:宋体">地址为</span><span style="font-family:Verdana">192.168.1.8</span><span style="font-family:宋体">的</span><span style="font-family:Verdana">MAC</span><span style="font-family:宋体">地址（通过</span><span style="font-family:Verdana">ARP</span><span style="font-family:宋体">解析获得）。</span><span style="font-family:Arial">
					</span></span></div>
*   <div style="background: white"><span style="color:#333333; font-size:10pt"><span style="font-family:宋体">和单播</span><span style="font-family:Verdana">IP</span><span style="font-family:宋体">地址</span><span style="font-family:Verdana"> 192.168.1.6 </span><span style="font-family:宋体">的通信：在进行相与计算时，</span><span style="font-family:Verdana">1</span><span style="font-family:宋体">、</span><span style="font-family:Verdana">3</span><span style="font-family:宋体">、</span><span style="font-family:Verdana">6 </span><span style="font-family:宋体">项匹配，但是</span><span style="font-family:Verdana">6</span><span style="font-family:宋体">项为最长匹配路由，因此选择</span><span style="font-family:Verdana">6</span><span style="font-family:宋体">项。</span><span style="font-family:Verdana">6</span><span style="font-family:宋体">项的网关地址为本地环回地址</span><span style="font-family:Verdana">127.0.0.1</span><span style="font-family:宋体">，因此直接将数据包发送至本地环回地址。</span><span style="font-family:Arial">
					</span></span></div>
*   <div style="background: white"><span style="color:#333333; font-size:10pt"><span style="font-family:宋体">和单播</span><span style="font-family:Verdana">IP</span><span style="font-family:宋体">地址</span><span style="font-family:Verdana"> 192.168.1.245 </span><span style="font-family:宋体">的通信：在进行相与计算时，</span><span style="font-family:Verdana">1</span><span style="font-family:宋体">、</span><span style="font-family:Verdana">3</span><span style="font-family:宋体">、</span><span style="font-family:Verdana">4</span><span style="font-family:宋体">、</span><span style="font-family:Verdana">5 </span><span style="font-family:宋体">项匹配，但是</span><span style="font-family:Verdana">4</span><span style="font-family:宋体">、</span><span style="font-family:Verdana">5</span><span style="font-family:宋体">项均为最长匹配路由，所以此时根据跃点数进行选择，</span><span style="font-family:Verdana">5 </span><span style="font-family:宋体">项具有更低的跃点数，因此选择</span><span style="font-family:Verdana">5</span><span style="font-family:宋体">项；在发送数据包时，目的</span><span style="font-family:Verdana">IP</span><span style="font-family:宋体">地址为</span><span style="font-family:Verdana">192.168.1.254</span><span style="font-family:宋体">、目的</span><span style="font-family:Verdana">MAC</span><span style="font-family:宋体">地址为</span><span style="font-family:Verdana">192.168.1.7</span><span style="font-family:宋体">的</span><span style="font-family:Verdana">MAC</span><span style="font-family:宋体">地址</span><span style="font-family:Verdana">
					</span><span style="font-family:宋体">（通过</span><span style="font-family:Verdana">ARP</span><span style="font-family:宋体">解析获得）。</span><span style="font-family:Arial">
					</span></span></div>
*   <div style="background: white"><span style="color:#333333; font-size:10pt"><span style="font-family:宋体">和单播</span><span style="font-family:Verdana">IP</span><span style="font-family:宋体">地址</span><span style="font-family:Verdana"> 10.1.1.1 </span><span style="font-family:宋体">的通信：在进行相与计算时，只有</span><span style="font-family:Verdana"> 1 </span><span style="font-family:宋体">项匹配；在发送数据包时，目的</span><span style="font-family:Verdana">IP</span><span style="font-family:宋体">地址为</span><span style="font-family:Verdana">10.1.1.1</span><span style="font-family:宋体">、目的</span><span style="font-family:Verdana">MAC</span><span style="font-family:宋体">地址为</span><span style="font-family:Verdana">192.168.1.1</span><span style="font-family:宋体">的</span><span style="font-family:Verdana">MAC</span><span style="font-family:宋体">地址（通过</span><span style="font-family:Verdana">ARP</span><span style="font-family:宋体">解析获得）。</span><span style="font-family:Arial">
					</span></span></div>
*   <div style="background: white"><span style="color:#333333; font-size:10pt"><span style="font-family:宋体">和子网广播地址</span><span style="font-family:Verdana"> 192.168.1.255 </span><span style="font-family:宋体">的通信：在进行相与计算时，</span><span style="font-family:Verdana">1</span><span style="font-family:宋体">、</span><span style="font-family:Verdana">3</span><span style="font-family:宋体">、</span><span style="font-family:Verdana">4</span><span style="font-family:宋体">、</span><span style="font-family:Verdana">5</span><span style="font-family:宋体">、</span><span style="font-family:Verdana">7 </span><span style="font-family:宋体">项匹配，但是</span><span style="font-family:Verdana">7</span><span style="font-family:宋体">项为最长匹配路由，因此选择</span><span style="font-family:Verdana">7</span><span style="font-family:宋体">项。</span><span style="font-family:Verdana">7</span><span style="font-family:宋体">项的网关地址为本地计算机的网络接口，因此在发送数据包时，目的</span><span style="font-family:Verdana">IP</span><span style="font-family:宋体">地址为</span><span style="font-family:Verdana"> 192.168.1.255</span><span style="font-family:宋体">，目的</span><span style="font-family:Verdana">MAC</span><span style="font-family:宋体">地址为以太网广播地址</span><span style="font-family:Verdana">FF:FF:FF:FF:FF:FF</span><span style="font-family:宋体">。</span><span style="font-family:Arial">
					</span></span></div>

<span style="color:#333333; font-size:10pt"><span style="font-family:Arial; background-color:white"> </span><span style="font-family:宋体; background-color:white">配好</span><span style="font-family:Arial; background-color:white">ethWan  </span><span style="font-family:宋体; background-color:white">但是不能</span><span style="font-family:Arial; background-color:white">ping</span><span style="font-family:宋体; background-color:white">通网关？</span><span style="font-family:Arial">

<span style="background-color:white">&gt; ping 192.168.10.134</span>
<span style="background-color:white">PING 192.168.10.134 (192.168.10.134): 56 data bytes</span>

<span style="background-color:white">--- 192.168.10.134 ping statistics ---</span>
<span style="background-color:white">4 packets transmitted, 0 packets received, 100% packet loss</span>
<span style="background-color:white"> &gt; </span>
<span style="background-color:white"> &gt; </span>
<span style="background-color:white"> &gt; wan show</span>
<span style="background-color:white">VCC     Con.    Service         Interface       Proto.  IGMP    Status          IP</span>
<span style="background-color:white">        ID      Name            Name                                            address</span>
<span style="background-color:white">N/A     0       pppoe_usb3g     ppp7            PPPoE   Disable Unconfigured    (null)</span>
<span style="background-color:white">N/A     0       ipoe_eth0       eth0            IPoE    Enable  Connected       192.168.10.86</span>
<span style="background-color:white"> &gt; </span>
<span style="background-color:white"> &gt; route show</span>
<span style="background-color:white">Kernel IP routing table</span>
<span style="background-color:white">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span>
<span style="background-color:white">192.168.10.0    *               255.255.255.0   U     0      0        0 br0</span>
<span style="background-color:white">192.168.10.0    *               255.255.255.0   U     0      0        0 eth0</span>
<span style="background-color:white">192.168.10.0    192.168.10.134  255.255.255.0   UG    1      0        0 br0</span>
<span style="background-color:white">default         192.168.10.134  0.0.0.0         UG    0      0        0 eth0</span>
<span style="background-color:white"> &gt; </span>
<span style="background-color:white"> &gt; ping 192.168.10.134</span>
<span style="background-color:white">PING 192.168.10.134 (192.168.10.134): 56 data bytes</span>
<span style="background-color:white">^C</span>
<span style="background-color:white">--- 192.168.10.134 ping statistics ---</span>
<span style="background-color:white">2 packets transmitted, 0 packets received, 100% packet loss</span>
<span style="background-color:white"> &gt; </span>
<span style="background-color:white"> &gt; </span>
<span style="background-color:white"> &gt; ifconfig br0           </span>
<span style="background-color:white">br0       Link encap:Ethernet  HWaddr 00:1A:2B:07:11:00  </span>
<span style="background-color:white">          inet addr:192.168.10.85  Bcast:192.168.10.255  Mask:255.255.255.0</span>
<span style="background-color:white">          UP BROADCAST RUNNING ALLMULTI MULTICAST  MTU:1500  Metric:1</span>
<span style="background-color:white">          RX packets:3121 errors:0 dropped:0 overruns:0 frame:0</span>
<span style="background-color:white">          TX packets:2477 errors:0 dropped:0 overruns:0 carrier:0</span>
<span style="background-color:white">          collisions:0 txqueuelen:0 </span>
<span style="background-color:white">          RX bytes:391982 (382.7 KiB)  TX bytes:2480685 (2.3 MiB)</span>

<span style="background-color:white"> &gt; ifconfig br0 192.168.1.85</span>
<span style="background-color:white"> &gt; route show</span>
<span style="background-color:white">Kernel IP routing table</span>
<span style="background-color:white">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span>
<span style="background-color:white">192.168.1.0     *               255.255.255.0   U     0      0        0 br0</span>
<span style="background-color:white">192.168.10.0    *               255.255.255.0   U     0      0        0 eth0</span>
<span style="background-color:white">default         192.168.10.134  0.0.0.0         UG    0      0        0 eth0</span>
<span style="background-color:white"> &gt; </span>
<span style="background-color:white"> &gt; ping 192.168.10.134</span>
<span style="background-color:white">PING 192.168.10.134 (192.168.10.134): 56 data bytes</span>
<span style="background-color:white">64 bytes from 192.168.10.134: seq=0 ttl=64 time=1.221 ms</span>
<span style="background-color:white">64 bytes from 192.168.10.134: seq=1 ttl=64 time=1.151 ms</span>
<span style="background-color:white">64 bytes from 192.168.10.134: seq=2 ttl=64 time=2.143 ms</span>
<span style="background-color:white">64 bytes from 192.168.10.134: seq=3 ttl=64 time=1.561 ms</span>

</span><span style="font-family:宋体; background-color:white">总结：</span><span style="font-family:Arial; background-color:white">lan</span><span style="font-family:宋体; background-color:white">和</span><span style="font-family:Arial; background-color:white">wan</span><span style="font-family:宋体; background-color:white">的网段不能相同</span></span>
