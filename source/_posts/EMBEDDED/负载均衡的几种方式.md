---
title: 负载均衡的几种方式
id: 308
comment: false
categories:
  - arm
date: 2016-05-03 11:12:42
tags:
---

#  DNS负载均衡

<!-- more -->
<span style="font-size:12pt">　　DNS负载均衡技术是在DNS服务器中为同一个主机名配置多个IP地址，在应答DNS查询时，DNS服务器对每个查询将以DNS文件中主机记录 的IP地址按顺序返回不同的解析结果，将客户端的访问引导到不同的机器上去，使得不同的客户端访问不同的服务器，从而达到负载均衡的目的。
</span>

<span style="font-size:12pt">　　DNS负载均衡的优点是经济简单易行，并且服务器可以位于internet上任意的位置。但它也存在不少缺点：
</span>

<span style="font-size:12pt">为了使本DNS服务器和其他DNS服务器及时交互，保证DNS数据及时更新，使地址能随机分配，一般都要将DNS的刷新时间设置的较小，但太小将会使DNS流量大增造成额外的网络问题。
</span>

<span style="font-size:12pt">一旦某个服务器出现故障，即使及时修改了DNS设置，还是要等待足够的时间（刷新时间）才能发挥作用，在此期间，保存了故障服务器地址的客户计算机将不能正常访问服务器。
</span>

<span style="font-size:12pt">DNS负载均衡采用的是简单的轮循负载算法，不能区分服务器的差异，不能反映服务器的当前运行状态，不能做到为性能较好的服务器多分配请求，甚至会出现客户请求集中在某一台服务器上的情况。
</span>

<span style="font-size:12pt">要给每台服务器分配一个internet上的IP地址，这势必会占用过多的IP地址。
</span>

<span style="font-size:12pt">　　判断一个站点是否采用了DNS负载均衡的最简单方式就是连续的ping这个域名，如果多次解析返回的IP地址不相同的话，那么这个站点就很可能 采用的就是较为普遍的DNS负载均衡。但也不一定，因为如果采用的是DNS响应均衡，多次解析返回的IP地址也可能会不相同。不妨试试Ping一下<span style="color:#006699">www.yesky.com</span>，<span style="color:#006699">www.sohu.com</span>，<span style="color:#006699">www.yahoo.com</span>。
</span>

<span style="font-size:12pt">　　现假设有三台服务器来应对<span style="color:#006699">www.test.com</span>的请求。在采用BIND 8.x DNS服务器的unix系统上实现起来比较简单，只需在该域的数据记录中添加类似下面的结果：
</span>

<span style="font-size:12pt">　　www1    IN    A          192.1.1.1
</span>

<span style="font-size:12pt">　　www2    IN    A          192.1.1.2
</span>

<span style="font-size:12pt">　　www3    IN    A          192.1.1.3
</span>

<span style="font-size:12pt">　　www     IN    CNAME      www1
</span>

<span style="font-size:12pt">　　www     IN    CNAME      www2
</span>

<span style="font-size:12pt">　　www     IN    CNAME      www3
</span>

<span style="font-size:12pt">　　在NT下的实现也很简单，下面详细介绍在win2000 server下实现DNS负载均衡的过程，NT4.0类似：
</span>

<span style="font-size:12pt">打开"管理工具"下的"DNS"，进入DNS服务配置控制台。
</span>

<span style="font-size:12pt">打开相应 DNS 服务器的"属性"，在"高级"选项卡的"服务器选项"中，选中"启用循环"复选框。此步相当于在注册表记录HKEY_LOCAL_MACHINE\ SYSTEM\CurrentControlSet\Services\DNS\Parameters中添加一个双字节制值（dword值） RoundRobin，值为1。
</span>

<span style="font-size:12pt">打开正向搜索区域的相应区域（如test.com），新建主机添加主机 (A) 资源记录，记录如下：
</span>

<span style="font-size:12pt">www    IN    A          192.1.1.1
</span>

<span style="font-size:12pt">www    IN    A          192.1.1.2
</span>

<span style="font-size:12pt">www    IN    A          192.1.1.3
</span>

<span style="font-size:12pt">在这里可以看到的区别是在NT下一个主机名对应多个IP地址记录，但在unix下，是先添加多个不同的主机名分别对应个自的IP地址，然后再把这些主机赋同一个别名（CNAME）来实现的。
</span>

<span style="font-size:12pt">在此需要注意的是，NT下本地子网优先级会取代多宿主名称的循环复用，所以在测试时，如果做测试用的客户机IP地址与主机资源记录的IP在同一有类掩码范围内，就需要清除在"高级"选项卡"服务器选项"中的"启用netmask排序"。
</span>

# NAT负载均衡

<span style="font-size:12pt">　 　NAT（Network Address Translation 网络地址转换）简单地说就是将一个IP地址转换为另一个IP地址，一般用于未经注册的内部地址与合法的、已获注册的Internet IP地址间进行转换。适用于解决Internet IP地址紧张、不想让网络外部知道内部网络结构等的场合下。每次NAT转换势必会增加NAT设备的开销，但这种额外的开销对于大多数网络来说都是微不足道 的，除非在高带宽有大量NAT请求的网络上。
</span>

<span style="font-size:12pt">　　NAT负载均衡将一个外部IP地址映射为多个内部IP地址，对每次连接请求动态地转换为一个内部服务器的地址，将外部连接请求引到转换得到地址的那个服务器上，从而达到负载均衡的目的。
</span>

<span style="font-size:12pt">　　NAT负载均衡是一种比较完善的负载均衡技术，起着NAT负载均衡功能的设备一般处于内部服务器到外部网间的网关位置，如路由器、防火墙、四层交换机、专用负载均衡器等，均衡算法也较灵活，如随机选择、最少连接数及响应时间等来分配负载。
</span>

<span style="font-size:12pt">　 　NAT负载均衡可以通过软硬件方式来实现。通过软件方式来实现NAT负载均衡的设备往往受到带宽及系统本身处理能力的限制，由于NAT比较接近网络的低 层，因此就可以将它集成在硬件设备中，通常这样的硬件设备是第四层交换机和专用负载均衡器，第四层交换机的一项重要功能就是NAT负载均衡。
</span>

<span style="font-size:12pt">　　下面以实例介绍一下Cisco路由器NAT负载均衡的配置：
</span>

<span style="font-size:12pt">　 　现有一台有一个串行接口和一个Ethernet接口的路由器，Ethernet口连接到内部网络，内部网络上有三台web服务器，但都只是低端配置，为 了处理好来自Internet上大量的web连接请求，因此需要在此路由器上做NAT负载均衡配置，把发送到web服务器合法Internet IP地址的报文转换成这三台服务器的内部本地地址。 其具体配置过程如下：
</span>

<span style="font-size:12pt">做好路由器的基本配置，并定义各个接口在做NAT时是内部还是外部接口。
</span>

<span style="font-size:12pt">然后定义一个标准访问列表（standard access list），用来标识要转换的合法IP地址。
</span>

<span style="font-size:12pt">再定义NAT地址池来标识内部web服务器的本地地址，注意要用到关键字rotary，表明我们要使用轮循（Round Robin）的方式从NAT地址池中取出相应IP地址来转换合法IP报文。
</span>

<span style="font-size:12pt">最后，把目标地址为访问表中IP的报文转换成地址池中定义的IP地址。
</span>

<span style="font-size:12pt">　　相应配置文件如下：
</span>

<span style="font-size:12pt">interface Ethernet0/0
</span>

<span style="font-size:12pt">ip address 192.168.1.4 255.255.255.248
</span>

<span style="font-size:12pt">ip nat inside
</span>

<span style="font-size:12pt">!
</span>

<span style="font-size:12pt">interface Serial0/0
</span>

<span style="font-size:12pt">ip address 200.200.1.1 255.255.255.248
</span>

<span style="font-size:12pt">ip nat outside
</span>

<span style="font-size:12pt">!
</span>

<span style="font-size:12pt">ip access-list 1 permit 200.200.1.2
</span>

<span style="font-size:12pt">!
</span>

<span style="font-size:12pt">ip nat pool websrv 192.168.1.1 192.168.1.3 netmask 255.255.255.248 type rotary
</span>

<span style="font-size:12pt">ip nat inside destination list 1 pool websrv
</span>

![](http://www.madhex.com/wp-content/uploads/2016/05/050316_0624_1.png)![](http://www.madhex.com/wp-content/uploads/2016/05/050316_0624_2.png)<span style="font-size:12pt">
		</span>

# 反向代理负载均衡

<span style="font-size:12pt">　　普通代理方式是代理内部网络用户访问internet上服务器的连接请求，客户端必须指定代理服务器,并将本来要直接发送到internet上服务器的连接请求发送给代理服务器处理。
</span>

<span style="font-size:12pt">　　反向代理（Reverse Proxy）方式是指以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就表现为一个服务器。
</span>

<span style="font-size:12pt">　　反向代理负载均衡技术是把将来自internet上的连接请求以反向代理的方式动态地转发给内部网络上的多台服务器进行处理，从而达到负载均衡的目的。
</span>

<span style="font-size:12pt">　 　反向代理负载均衡能以软件方式来实现，如apache mod_proxy、netscape proxy等，也可以在高速缓存器、负载均衡器等硬件设备上实现。 反向代理负载均衡可以将优化的负载均衡策略和代理服务器的高速缓存技术结合在一起，提升静态网页的访问速度，提供有益的性能；由于网络外部用户不能直接访 问真实的服务器，具备额外的安全性（同理，NAT负载均衡技术也有此优点）。
</span>

<span style="font-size:12pt">　　其缺点主要表现在以下两个方面：
</span>

<span style="font-size:12pt">反向代理是处于OSI参考模型第七层应用的，所以就必须为每一种应用服务专门开发一个反向代理服务器，这样就限制了反向代理负载均衡技术的应用范围，现在一般都用于对web服务器的负载均衡。
</span>

<span style="font-size:12pt">针对每一次代理，代理服务器就必须打开两个连接，一个对外，一个对内，因此在并发连接请求数量非常大的时候，代理服务器的负载也就非常大了，在最后代理服务器本身会成为服务的瓶颈。
</span>

<span style="font-size:12pt">　　一般来讲，可以用它来对连接数量不是特别大，但每次连接都需要消耗大量处理资源的站点进行负载均衡，如search。
</span>

<span style="font-size:12pt">　　下面以在apache mod_proxy下做的反向代理负载均衡为配置实例：在站点<span style="color:#006699">www.test.com</span>，我们按提供的内容进行分类，不同的服务器用于提供不同的内容服务，将对<span style="color:#006699">http://www.test.com/news</span>的访问转到IP地址为192.168.1.1的内部服务器上处理，对<span style="color:#006699">http://www.test.com/it</span>的访问转到服务器192.168.1.2上，对<span style="color:#006699">http://www.test.com/life</span>的访问转到服务器192.168.1.3上，对<span style="color:#006699">http://www.test.com/love</span>的访问转到合作站点<span style="color:#006699">http://www.love.com</span>上，从而减轻本apache服务器的负担，达到负载均衡的目的。
</span>

<span style="font-size:12pt">　　首先要确定域名<span style="color:#006699">www.test.com</span>在DNS上的记录对应apache服务器接口上具有internet合法注册的IP地址，这样才能使internet上对<span style="color:#006699">www.test.com</span>的所有连接请求发送给本台apache服务器。
</span>

<span style="font-size:12pt">　　在本台服务器的apache配置文件httpd.conf中添加如下设置：
</span>

<span style="font-size:12pt">　　proxypass     /news      <span style="color:#006699">http://192.168.1.1</span>
		</span>

<span style="font-size:12pt">　　proxypass     /it      <span style="color:#006699">http://192.168.1.2</span>
		</span>

<span style="font-size:12pt">　　proxypass     /life     <span style="color:#006699">http://192.168.1.3</span>
		</span>

<span style="font-size:12pt">　　proxypass     /love     <span style="color:#006699">http://www.love.com</span>
		</span>

<span style="font-size:12pt">　　注意，此项设置最好添加在httpd.conf文件"Section 2"以后的位置，服务器192.168.1.1-3也应是具有相应功能的www服务器，在重启服务时，最好用apachectl configtest命令检查一下配置是否有误。
</span>

# 代理服务器

<span style="font-size:12pt"> 使用代理服务器，可以将请求转发给内部的服务器，使用这种加速模式显然可以提升静态网页的访问速度。然而，也可以考虑这样一种 
技术，使用代理服务器将请求均匀转发给多台服务器，从而达到负载均衡的目的。
</span>

# 地址转换网关

<span style="font-size:12pt"> 支持负载均衡的地址转换网关，可以将一个外部IP地址映射为多个内部IP地址，对每次TCP连接请求动态使用其中一个内部地 
址，达到负载均衡的目的。
</span>

<span style="font-size:12pt">协议内部支持负载均衡
</span>

<span style="font-size:12pt"> 除了这三种负载均衡方式之外，有的协议内部支持与负载均衡相关的功能，例如HTTP协议中的重定向能力等，HTTP运行于 
TCP连接的最高层。
</span>

# 混合型负载均衡

<span style="font-size:12pt">　 　在有些大型网络，由于多个服务器群内硬件设备、各自的规模、提供的服务等的差异，我们可以考虑给每个服务器群采用最合适的负载均衡方式，然后又在这多个 服务器群间再一次负载均衡或群集起来以一个整体向外界提供服务（即把这多个服务器群当做一个新的服务器群），从而达到最佳的性能。我们将这种方式称之为混 合型负载均衡。此种方式有时也用于单台均衡设备的性能不能满足大量连接请求的情况下。
</span>

<span style="font-size:12pt">　　下图展示了一个应用示例，三个服务器群针对各自的特点，分别采用了不同的负载均衡方式。当客户端发出域名解析请求时，DNS服务器依次把它解析成三个服务器群的VIP，如此把客户端的连接请求分别引向三个服务器群，从而达到了再一次负载均衡的目的。
</span>

<span style="font-size:12pt">　　在图中大家可能注意到，负载均衡设备在网络拓朴上，可以处于外部网和内部网络间网关的位置，也可以和内部服务器群处于并行的位置，甚至可以处于内部网络或internet上的任意位置，特别是在采用群集负载均衡时，根本就没有单独的负载均衡设备。
</span>

<span style="font-size:12pt">　　服务器群内各服务器只有提供相同内容的服务才有负载均衡的意义，特别是在DNS负载均衡时。要不然，这样会造成大量连接请求的丢失或由于多次返回内容的不同给客户造成混乱。
</span>

<span style="font-size:12pt">　　所以，如图的这个示例在实际中可能没有多大的意义，因为如此大的服务内容相同但各服务器群存在大量差异的网站并不多见。 但做为一个示例，相信还是很有参考意义的。
</span>

![](http://www.madhex.com/wp-content/uploads/2016/05/050316_0624_3.png)![](http://www.madhex.com/wp-content/uploads/2016/05/050316_0624_4.png)<span style="font-size:12pt">
		</span>

<span style="font-size:12pt">本文来源于[<span style="color:#1c67ac; text-decoration:underline">http://www.ccw.com.cn/cso/htm2007/20071216_357499.shtml</span>](http://www.ccw.com.cn/cso/htm2007/20071216_357499.shtml)
		</span>
